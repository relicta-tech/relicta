name: Release

on:
  workflow_dispatch:
    inputs:
      dry-run:
        description: 'Run in dry-run mode (no tag/release created)'
        required: false
        type: boolean
        default: false

env:
  GO_VERSION: '1.24'
  GOTOOLCHAIN: local

# Prevent concurrent releases
concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: false

# Default minimal permissions
permissions:
  contents: read

jobs:
  # Build and test before release
  build:
    name: Build and Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Run tests
        run: go test -v -race ./...

      - name: Build release artifacts
        run: make release-build

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-artifacts
          path: dist/

  # Release using the built binary
  release:
    name: Release with Relicta
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write       # Needed for creating releases
      id-token: write       # Needed for OIDC token (Sigstore signing)
      attestations: write   # Needed for artifact attestations

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-artifacts
          path: dist/

      - name: Extract and setup relicta binary
        run: |
          mkdir -p bin
          tar -xzf dist/relicta_Linux_x86_64.tar.gz -C bin --strip-components=1
          chmod +x bin/relicta
          echo "$PWD/bin" >> $GITHUB_PATH
          bin/relicta version

      - name: Build GitHub plugin
        run: |
          tar -xzf dist/github_linux_x86_64.tar.gz -C bin 2>/dev/null || true
          ls -la bin/

      - name: Run relicta release workflow
        if: ${{ !inputs.dry-run }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Plan the release
          bin/relicta plan

          # Bump version and capture the new version from JSON output
          BUMP_OUTPUT=$(bin/relicta bump --json)
          echo "Bump output: $BUMP_OUTPUT"
          # Extract JSON from the output (skip header lines before the JSON object)
          VERSION=$(echo "$BUMP_OUTPUT" | grep -A100 '^{' | jq -r '.tag_name')
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "New version: $VERSION"

          # Generate notes
          bin/relicta notes

          # Approve
          bin/relicta approve --yes

          # Push the tag
          git push origin $VERSION || true

      - name: Generate checksums
        if: ${{ !inputs.dry-run }}
        run: |
          cd dist
          sha256sum relicta_*.tar.gz relicta_*.zip > checksums.txt
          cd ..

      # Generate SLSA provenance attestations for release artifacts
      - name: Generate attestations for release archives
        if: ${{ !inputs.dry-run }}
        uses: actions/attest-build-provenance@v2
        with:
          subject-path: |
            dist/relicta_Darwin_aarch64.tar.gz
            dist/relicta_Darwin_x86_64.tar.gz
            dist/relicta_Linux_aarch64.tar.gz
            dist/relicta_Linux_x86_64.tar.gz
            dist/relicta_Windows_x86_64.zip

      - name: Create GitHub Release
        if: ${{ !inputs.dry-run }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Create release with binaries
          gh release create $VERSION \
            --title "Relicta $VERSION" \
            --generate-notes \
            dist/relicta_Darwin_aarch64.tar.gz \
            dist/relicta_Darwin_x86_64.tar.gz \
            dist/relicta_Linux_aarch64.tar.gz \
            dist/relicta_Linux_x86_64.tar.gz \
            dist/relicta_Windows_x86_64.zip \
            dist/checksums.txt

      - name: Dry run
        if: ${{ inputs.dry-run }}
        run: |
          bin/relicta plan --dry-run
          echo "Dry run complete - no release created"
