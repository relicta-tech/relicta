name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      dry-run:
        description: 'Run in dry-run mode (no release created)'
        required: false
        type: boolean
        default: false

env:
  GO_VERSION: '1.24'
  GOTOOLCHAIN: local

# Prevent concurrent releases
concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: false

# Default minimal permissions
permissions:
  contents: read

jobs:
  # Governance check with Relicta
  governance:
    name: Release Governance
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      approved: ${{ steps.governance.outputs.approved }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Build Relicta
        run: make build

      - name: Get version from tag
        id: version
        run: |
          if [[ "${{ github.ref_type }}" == "tag" ]]; then
            VERSION="${{ github.ref_name }}"
          else
            VERSION=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Release version: $VERSION"

      - name: Run Relicta governance
        id: governance
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Validate the release plan (governance check)
          if bin/relicta plan --dry-run 2>&1; then
            echo "approved=true" >> $GITHUB_OUTPUT
          else
            echo "approved=false" >> $GITHUB_OUTPUT
            echo "::warning::Release governance check failed"
          fi

  # Build and release with GoReleaser
  release:
    name: Build & Release
    needs: governance
    if: ${{ !inputs.dry-run && needs.governance.outputs.approved == 'true' }}
    runs-on: ubuntu-latest
    permissions:
      contents: write       # Create releases and upload assets
      id-token: write       # OIDC token for Sigstore signing
      packages: write       # Push container images (if needed)
      attestations: write   # Artifact attestations

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Install Cosign
        uses: sigstore/cosign-installer@v3

      - name: Install Syft
        uses: anchore/sbom-action/download-syft@v0

      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@v6
        with:
          distribution: goreleaser
          version: '~> v2'
          args: release --clean
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          HOMEBREW_TAP_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}

      - name: Generate attestations
        uses: actions/attest-build-provenance@v2
        with:
          subject-path: |
            dist/relicta_*.tar.gz
            dist/relicta_*.zip
            dist/checksums.txt

      - name: Build Relicta for post-release
        run: make build

      - name: Record release outcome
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Record successful release to CGP memory
          bin/relicta release --yes --skip-push || true

  # Dry run mode
  dry-run:
    name: Dry Run
    if: ${{ inputs.dry-run }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Build Relicta
        run: make build

      - name: Relicta dry run
        run: bin/relicta plan --dry-run

      - name: GoReleaser dry run
        uses: goreleaser/goreleaser-action@v6
        with:
          distribution: goreleaser
          version: '~> v2'
          args: release --snapshot --clean
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: List artifacts
        run: ls -la dist/
