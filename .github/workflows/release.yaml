name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      dry-run:
        description: 'Run in dry-run mode (no tag/release created)'
        required: false
        type: boolean
        default: false

env:
  GO_VERSION: '1.24'
  GOTOOLCHAIN: local

# Prevent concurrent releases
concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: false

# Default minimal permissions
permissions:
  contents: read

jobs:
  # Build and test before release
  build:
    name: Build and Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Run tests
        run: go test -v -race ./...

      - name: Build release artifacts
        run: make release-build

      - name: Upload artifacts
        uses: actions/upload-artifact@v6
        with:
          name: release-artifacts
          path: dist/

  # Release using the built binary
  release:
    name: Release with Relicta
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write       # Needed for creating releases
      id-token: write       # Needed for OIDC token (Sigstore signing)
      attestations: write   # Needed for artifact attestations

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Download build artifacts
        uses: actions/download-artifact@v7
        with:
          name: release-artifacts
          path: dist/

      - name: Extract and setup relicta binary
        run: |
          mkdir -p bin
          tar -xzf dist/relicta_Linux_x86_64.tar.gz -C bin --strip-components=1
          chmod +x bin/relicta
          echo "$PWD/bin" >> $GITHUB_PATH
          bin/relicta version

      - name: Build GitHub plugin
        run: |
          tar -xzf dist/github_linux_x86_64.tar.gz -C bin 2>/dev/null || true
          ls -la bin/

      # Run relicta release workflow
      # The release command auto-detects if HEAD is tagged (tag-push mode)
      # and handles both new releases and tag-push scenarios intelligently
      - name: Run relicta release
        if: ${{ !inputs.dry-run }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Run release workflow - auto-detects tag-push mode
          bin/relicta release --yes --skip-push

          # Get the version from the tag
          if [[ "${{ github.ref_type }}" == "tag" ]]; then
            VERSION="${{ github.ref_name }}"
          else
            VERSION=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          fi
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "Release version: $VERSION"

      - name: Generate checksums
        if: ${{ !inputs.dry-run }}
        run: |
          cd dist
          sha256sum relicta_*.tar.gz relicta_*.zip > checksums.txt
          cd ..

      # Generate SLSA provenance attestations for release artifacts
      - name: Generate attestations for release archives
        if: ${{ !inputs.dry-run }}
        uses: actions/attest-build-provenance@v3
        with:
          subject-path: |
            dist/relicta_Darwin_aarch64.tar.gz
            dist/relicta_Darwin_x86_64.tar.gz
            dist/relicta_Linux_aarch64.tar.gz
            dist/relicta_Linux_x86_64.tar.gz
            dist/relicta_Windows_x86_64.zip

      - name: Check if release exists
        if: ${{ !inputs.dry-run }}
        id: check-release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if gh release view "$VERSION" &>/dev/null; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Create GitHub Release
        if: ${{ !inputs.dry-run && steps.check-release.outputs.exists != 'true' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create $VERSION \
            --title "Relicta $VERSION" \
            --generate-notes \
            dist/relicta_Darwin_aarch64.tar.gz \
            dist/relicta_Darwin_x86_64.tar.gz \
            dist/relicta_Linux_aarch64.tar.gz \
            dist/relicta_Linux_x86_64.tar.gz \
            dist/relicta_Windows_x86_64.zip \
            dist/checksums.txt

      - name: Upload assets to existing release
        if: ${{ !inputs.dry-run && steps.check-release.outputs.exists == 'true' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Release $VERSION already exists - uploading/updating assets"
          for asset in relicta_Darwin_aarch64.tar.gz relicta_Darwin_x86_64.tar.gz relicta_Linux_aarch64.tar.gz relicta_Linux_x86_64.tar.gz relicta_Windows_x86_64.zip checksums.txt; do
            gh release delete-asset $VERSION $asset --yes 2>/dev/null || true
          done
          gh release upload $VERSION \
            dist/relicta_Darwin_aarch64.tar.gz \
            dist/relicta_Darwin_x86_64.tar.gz \
            dist/relicta_Linux_aarch64.tar.gz \
            dist/relicta_Linux_x86_64.tar.gz \
            dist/relicta_Windows_x86_64.zip \
            dist/checksums.txt

      - name: Release summary
        if: ${{ !inputs.dry-run }}
        run: |
          echo "## Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** $VERSION" >> $GITHUB_STEP_SUMMARY
          echo "- **Release URL:** https://github.com/${{ github.repository }}/releases/tag/$VERSION" >> $GITHUB_STEP_SUMMARY

      - name: Dry run
        if: ${{ inputs.dry-run }}
        run: |
          bin/relicta release --yes --dry-run
          echo "Dry run complete - no release created"
